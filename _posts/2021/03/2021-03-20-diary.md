---
title: 328 日目（曇り）目の疲れが酷い
---

[ウルファールのサンプルゲーム with DTC][bshf21b] で物語を進めずにアイテム集め。ドラゴンスレイヤーを 6 本かき集める。
単に攻撃力が欲しい。気が済んで 1:00 就寝。

8:10 起床。洗濯機を回しつつ納豆とロールパンを食す。携帯電話で天気予報を確認。今日は降らない。
洗濯物を干して PC をかばんに入れて外出。コンビニに雑誌チェックで道草を食いつつ移動。

9:35 八広図書館。朝刊は全部出払っているのでいきなり入館する。キャレルに着席。のどが渇いた。水を飲めばよかった。

* [&#x23;612 アレックスキッドのミラクルワールド Alex Kidd BGM ギターメドレー - YouTube](https://www.youtube.com/watch?v=tV8dohKZ0JU):
  ダウンロード。このチャンネルの場合は知らない曲でもダウンロード。
* [【新宿fairy】ゲストとしての役目を果たせたのか聞きにいってきた - YouTube](https://www.youtube.com/watch?v=KevCNJNkvho):
  自動卓トラブルが連続しているが、ゲストということもあり？手慣れた様子で回復する。
* Scrapy の学習。ドキュメントを読むだけでコードを走らせないという、図書館へ来た意味を打ち消すような本末転倒ぶり。

11:40 退館。団地から出る前に朝刊（朝日）を読む。イトーヨーカドー曳舟店に移動して体温計測とトイレ。

12:15 曳舟の部屋に戻る。PC を戻しておやつ休憩。今気づいたが、ダウンロードしたつもりの MP4 がない。
コマンド実行するのを忘れていたようだ。いよいよボケが始まったか。

12:50 時間があるのでゲーム。ウルファールのサンプルゲーム with DTC][bshf21b] を少し進める。
通せんぼしているボスを倒す。最上階はフリーリがウロウロしているのだが、アイテムだけ盗んで逃げることを繰り返しておきたい。
待てよ。闇落ちした集落を放置したままだったが、あそこは確か逃亡可能なのではなかったか。
盗みはそっちを優先したほうがパーティーの戦力の底上げになる。あとでやろう。

13:50 眠くないのに寝る。すると変な夢を見る。年頃の女子が集まる宿舎のような場所。
人間関係がどこかギスギスしていて不安になる。

15:40 起床。外出。押上駅バス停に直行してバスに乗る。

16:30 オリナス到着。早いのでテレビ売り場で時間を潰す。テレビ番組を映しているモニターがないのでとっとと退店。邪魔した。

16:50 タイトー F ステーションオリナス錦糸町店。

MJ 幻の旅客船第 6 便東風インフレダブル赤ルール。結果的に 8 クレ行ってしまう。
こういうルールなので迂闊にリーチするのは危ない。他家がミスってからアガリに行けばラスは回避できる。
しかし、幻の旅客船イベントは 3 着もラスも同じようなものなので、意味がなかったかもしれない。

```text
合計スコア -88.3
平均スコア -8.03

平均順位 2.73 着
トップ 1 回
二着 3 回
三着 5 回
ラス 2 回

アガリ率 20.45% (9)
アガリ飜平均 4.44
アガリ巡目平均 11.33 巡
振り込み率 15.91% (7)
```

あと気分転換にビートマニアの STEP UP を 2 プレイして退店。何かクリアランプが点いたかもしれない。

19:55 カスミオリナス錦糸町店。393 円。クーポン使用。

* 生姜焼き丼
* ブラックチョコ
* 野菜ジュース (900)

20:20 ビッグエー墨田業平店。451 円。

* 絹豆腐
* スライスチーズ (5)
* 大きなおむすび鮭
* ハムマヨパン
* ベーコン＆コーンマヨパン
* チョコチップクッキー

20:30 曳舟の部屋に戻る。入浴。21:00 出てくる。豆腐を食いながら PC を起動。
帳簿と日記を書けるところまで片付けて晩飯。

21:45 晩飯＆麻雀の練習終了。テザリングに移行。22:10 異状なしなのでゲームに。

* さっきの思いつきを実行する。サキュバスの鞭、ウィングブーツ、竜神の杖、ファイアブランド、悪魔の兜、魔界剣豪の頭蓋骨などを大量に入手する。
  それにしても宿屋にいるドリームペインターからわりと欲しい夢魔のブレイサーがなかなか集まらない。
  どうでもいいツインスマッシャーがダブつく。やはりこの集落の人々は倒さないで放置しておくのが正解らしい。
* ウルフにムチとブラックレイザーを装備させて直接攻撃させると、全体にレイザーもダメージを与えてなかなか具合がいい。
* ミカコ＆サンネリネ戦が意外に手強い。こんなに苦戦したかというくらい全滅する。
  ミカコには魅惑、サンネリネには凍結がわりと効く感じがする。浄化システムが補充されるのをうっかりしない。
  上手くいくとシルバーホースの長靴、ミスリスの兜、アゾット剣、ウィンドフォースの 4 種類が手に入るのか？
* ラストダンジョンの逃走不能戦闘が発生する条件が不明。
* カーミラ、ドラゴンバスター、フリーリは放置したまま。

## Scrapy Note

クラス `Request` と `Response` を見ていく。このフレームワークでは重要な要素だ。
後者に対するメソッド呼び出しのほうが圧倒的に多い。

### 要求と応答

`Request` のオブジェクトはスパイダー内部で `yield` されて Scrapy のフレームワークがそれを実行する。
そして `Response` オブジェクトをそのスパイダーに返すというような仕組みだ。

これらのサブクラスの特性を理解しておくことが重要だろう。

#### クラス `Request`

コンストラクターの使い方を先に習得する。スパイダーの適当なメソッドから次のような感じで生成する：

```python
Request(sample_url, callback=self.parse_sample)
Request(sample_url, callback=self.parse_sample, cb_kwargs=dict(main_url=response.url)
```

このようなオブジェクトを `return` または `yield` すると、新たに `Response` オブジェクトを伴って指定したコールバックが呼び出される。

```python
def parse_sample(self, response, main_url):
    # ...
```

クラス `Request` の主要フィールド一覧：

| name | description | comment |
|------|-------------|---------|
| `url` | この要求のエスケープ済み URL を表す文字列 | read-only |
| `method` | HTTP メソッドを表す文字列 | 大文字 |
| `headers` | HTTP ヘッダーを保持する辞書 | |
| `body` | HTTP ボデーそのもの `bytes` オブジェクト | read-only |

TODO: エラー処理

エラー処理 (`errback`) については、自作するよりもフレームワークの既定の動作で当分は間に合う。ログ出力で十分わかりやすい。

#### メタ

属性 `Request.meta` は辞書オブジェクトであってどんなデータでも入れておけるが、Scrapy が特別扱いするキーもある。
例えばキー `download_timeout` の値はダウンローダーがタイムアウトまで待機する時間を秒単位で指定されているものとして参照される。
（この項目は設定の `DOWNLOAD_TIMEOUT` の影響も受ける）。

#### 応答のダウンロードを中止する

スパイダークラスで次のようにすると、与えられた応答のダウンロードを中止することができる。
つまり `bytes_received` シグナルのハンドラーを次のように書いて、そこで例外 `StopDownload` を送出する。

```python
def on_bytes_received(self, data, request, spider):
    raise scrapy.exceptions.StopDownload(fail=False)
```

TODO: `fail=False` の指定により、応答に元々の固有の `errback` が呼び出されるのではなく、コールバックが呼び出されるようになる？

#### `Request` のサブクラス

* `FormRequest`: 何かを POST するフォームの対応する `Request` と考えてよい。
  例えば、よくあるログインページを通過するにはこれを利用することができる。

  ```python
  def parse(self, response, **kwargs):
      if (uid := getattr(self, 'uid', None)) is None:
          raise KeyError('missing -a uid=your-user-name')
      if (password := getattr(self, 'password', None)) is None:
          raise KeyError('missing -a password=your-password')
      return FormRequest.from_response(
          response,
          formdata={'uid': uid, 'password': password},
          callback=self._after_login)
  ```

* `JsonRequest`: JSON リクエストを処理できるクラス。コンストラクターの `data` に
  JSON シリアライズ可能なオブジェクトを渡せるということだ。

  ```python
  payload = dict(name1=value1, name2=value2)
  yield JsonRequest(url, data=payload)
  ```

#### クラス `Response`

クラス `Response` はオブジェクトを直接生成するのではなく、フレームワークから受け取るのが基本的だ。

主要フィールド：

| name | description | comment |
|------|-------------|---------|
| `url` | 応答の URL を表す文字列 | read-only |
| `status` | HTTP コードを表す数 | 200 とか 404 とか |
| `headers` | HTTP ヘッダーを表す辞書風オブジェクト | これに対して `.get()` や `.getlist()` などを呼び出すこともある |
| `body` | 応答ボデーを `bytes` で保持する | read-only |
| `request` | `self` を生み出した `Request` オブジェクト | `self.request.url` と `self.url` は一般には異なる |

主要メソッド：

| name | description | comment |
|------|-------------|---------|
| `follow(url, ...)` | URL への `Request` オブジェクトを返す | |
| `follow_all(urls, ...)` | 複数 URL それぞれへの `Request` オブジェクトを iterable にして返す | `Request` への引数はすべて共通 |

#### `Response` の派生クラス

Scrapy による派生クラスを記す。`Response` については派生クラスを利用者が書くこともできる。

`TextResponse`: クラス `Response` にエンコーディングの考え方を導入したものと考えてよい。
したがって次の主要フィールドが有用だ：

| name | description | comment |
|------|-------------|---------|
| `text` | 応答ボデーを `str` で表したもの | すなわち `self.body.decode(self.encoding)` に等しい |
| `encoding` | 応答のエンコーディングを表す文字列 | Scrapy が適宜解決、決定する |
| `selector` | 応答本文を対象とする `Selector` オブジェクト | これにより `self.text` を解析する |

主要メソッドは本質的には追加されていない。

* `.css()` や `.xpath()` は `.selector` の同名メソッドへのショートカットに過ぎない。
* `.json()` なるメソッドが提供されているらしいが、詳細不明。

`TextResponse` にはさらにサブクラスがある。`HtmlResponse` と `XmlResponse` だ。
しかし、これらに固有の性質、機能を利用者が用いることはほぼない。

[bshf21b]: https://wodifes.net/game/show/446
