---
title: Stream Selection
---

ここはオプション `-map` に関する説明だ。

`ffmpeg` には各出力ファイルのストリーム選択を手動で制御するためのオプション
`-map` がある。ユーザーは `-map` を飛ばして、以下に述べられる `ffmpeg` にスト
リームを自動的に選択させることができる。オプション `-vn`, `-an`, `-sn`, `-dn`
は、複雑なフィルタグラフー出力であるストリームを除き、手動で map されたか自動的
に選択されたかにかかわらず、映像、音声、字幕、データストリームを含めるのを飛ばす
のに使用できる。

## 4.1 Description

本節ではストリーム選択に関わる様々な規則について述べる。それから、これらの規則が
どのように適用されるかを例を挙げて示す。

### 4.1.1 Automatic stream selection

特定の出力ファイルに map オプションがない場合、`ffmpeg` は出力フォーマットを検査
し、映像、音声、字幕など、どの種類のストリームを含められるかを検査する。許容され
るストリーム種別ごとに、入力すべてから一つのストリームを（利用可能である限り）選
択する。

ストリーム選択基準は次に基づく：

* 映像は最も解像度の高いストリーム
* 音声は最も多くのチャンネルを含むストリーム
* 字幕は、最初に発見した副字幕ストリームになる。注意点：出力形式の既定の字幕エン
  コーダーは、文字ベースか画像ベースのどちらかで、同じ種類の字幕ストリームだけが
  選択される。

同種のストリームで等しく評価されるものが複数ある場合、最低インデックスストリーム
が選択される。

データまたは添付ストリームに関しては自動的に選択されることはない。`-map` 指定時
にしか採用されない。

### 4.1.2 Manual stream selection

オプション `-map` が使用された場合、ユーザーマップストリームしか出力ファイルに含まれない。
ただし、以下で述べられる filtergraph 出力に関する例外がある。

### 4.1.3 Complex filtergraphs

ラベルのないパッドを持つ複雑な filtergraph 出力ストリームがある場合、それらは最
初の出力ファイルに追加される。これは、そのストリーム種別が出力フォーマットで対応
されていない場合、致命的なエラーになる。map オプションがない場合、これらのスト
リームを含めると、その種別のストリーム自動選択が飛ばされることになる。map オプ
ションが存在する場合、マップされたストリームに加えて、これらの filtergraph スト
リームが含まれる。

ラベル付きパッドを持つ複雑な filtergraph 出力ストリームは、一度だけ、正確にマッ
プされなければならない。

----

TODO: ラベルとは？ パッドとは？

### 4.1.4 Stream handling

ストリーム処理はストリーム選択に依存しない（例外は後述する字幕）。ストリーム
処理は、特定の出力ファイル内のストリームに指定されたオプション `-codec` によって
設定される。特に、codec オプションは、ストリーム選択処理の後に `ffmpeg` が適用す
るため、後者に影響を与えない。オプション `-codec` が指定されていないストリーム種
別に対しては、`ffmpeg` は出力ファイルの muxer によって登録された既定の encoder
を選択する。

### 4.2 Examples

次の例は `ffmpeg` のストリーム選択方法の動作、癖、制限を説明するためのものだ。
次のような入力ファイルがあるとする（三つすべてを入力とする）：

```text
input file 'A.avi'
    stream 0: video 640x360
    stream 1: audio 2 channels

input file 'B.mp4'
    stream 0: video 1920x1080
    stream 1: audio 2 channels
    stream 2: subtitles (text)
    stream 3: audio 5.1 channels
    stream 4: subtitles (text)

input file 'C.mkv'
    stream 0: video 1280x720
    stream 1: audio 2 channels
    stream 2: subtitles (image)
```

メモ：このような情報はファイルに対して `ffprobe` を実行すれば確認できる。

#### Example: automatic stream selection

```console
ffmpeg -i A.avi -i B.mp4 out1.mkv out2.wav -map 1:a -c:a copy out3.mov
```

出力ファイルは三つ指定されている。最初の二つ (`out1.mkv`, `out2.wav`) はオプショ
ン `-map` がないので、これらのファイルストリームを自動選択する。

`out1.mkv` は Matroska コンテナーファイルで、映像、音声、字幕のストリームを受け付ける。
よって、`ffmpeg` は各種別の一つを選択しようとする：

* 映像：すべての入力映像ストリームの中で最も解像度の高いものは `B.mp4` のスト
  リーム 0であるので、それを選択する。
* 音声：チャンネル数が最も多い `B.mp4` からストリーム 3 を選択する。
* 字幕：`A.avi` と `B.mp4` のうち最初の字幕ストリームである `B.mp4` からストリー
  ム 2 を選択する。

`out2.wav` は音声ストリームのみを受け付ける。したがって、`B.mp4` のストリーム 3
のみが選択される。

```text
-map 1:a -c:a copy out3.mov
```

`out3.mov` ではオプション `-map` が設定されているため、ストリーム自動選択は行われない。
オプション `-map 1:a` 指定により、2 (`1` + 1) 番目の入力である `B.mp4` から音声ストリームのすべてが
オプション `-c:a copy` 指定により選択される。この出力ファイルは、他のストリームを含まない。

最初の二つの出力では、含まれるストリームのすべてが transcode される。選択される
encoder は各出力フォーマットで登録された既定のもので、選択された入力ストリームの
codec と一致しない場合がある。

三番目の出力では、音声ストリームの codec オプションが `copy` に設定されているた
め、decoding-filtering-encoding の処理は発生しないはずだが、その可能性はある。選
択ストリームパケットは、入力ファイルから伝達されて、出力ファイル内で混合されなけ
ればならない。

#### Example: automatic subtitles selection

```console
ffmpeg -i C.mkv out1.mkv -c:s dvdsub -an out2.mkv
```

`out1.mkv` は字幕ストリームも受け入れる Matroska コンテナーファイルだが、映像と
音声のストリームのみが選択されなければならないものとする。`C.mkv` の字幕ストリー
ムは画像ベースであり、Matroska muxer の既定の字幕 encoder はテキストベースなの
で、字幕の transcode 操作は失敗すると予想され、したがってストリームは選択されないのだ。

Note: ここでは字幕コピーオプションを明示しないと失敗する挙動を逆用しているということ。

```text
-c:s dvdsub -an out2.mkv
```

一方、`out2.mkv` ではコマンドに字幕 encoder が指定されている (`-c:s dvdsub`) の
で、映像ストリームに加えて、字幕ストリームが選択される。音声ストリームは `-an`
を指定してあるので含まれない。

#### Example: unlabeled filtergraph outputs

```console
ffmpeg -i A.avi -i C.mkv -i B.mp4 -filter_complex "overlay" out1.mp4 out2.srt
```

オプション `-filter_complex` を使って、単一の映像フィルターからなる filtergraph
を設定している。フィルター `overlay` は、ちょうど二つの映像入力を必要とするものだが、
何も指定されていないので、最初に利用可能な映像ストリーム二つ、
`A.avi` と `C.mkv` が選ばれる。

フィルターの出力パッドにはラベルがないので、最初の出力ファイル `out1.mp4` に送ら
れる。このため、映像ストリームの自動選択は飛ばされ、`B.mp4` のストリームが選択
されるはずだった。音声ストリームは、`B.mp4` のストリーム 3 など、最も多くのチャ
ンネルを持つストリームが自動選択される。しかし、MP4 形式には既定の字幕 encoder
が登録されておらず、利用者が字幕 encoder を指定していないため、字幕ストリームは
選択されない。

Note: パッドが何を指すのかわからない。

2 番目の出力ファイルである `out2.srt` は、文字ベースの字幕ストリームのみを受け付ける。
したがって、最初に利用可能な字幕ストリームは `C.mkv` にあるが、それは画像ベースであるため飛ばされる（さっきと同じ理由）。
選択ストリームである `B.mp4` のストリーム 2 は、最初の文字ベースの字幕ストリームだ。

#### Example: labeled filtergraph outputs

```console
ffmpeg -i A.avi -i B.mp4 -i C.mkv -filter_complex "[1:v]hue=s=0[outv];overlay;aresample" \
    -map '[outv]' -an        out1.mp4 \
                             out2.mkv \
    -map '[outv]' -map 1:a:0 out3.mkv
```

Note: `-filter_complex` の引数の読み方がわからないが、とりあえず読み続ける。

ラベル `[outv]` の付いた出力パッドが二度 map されているので、上記のコマンドは失
敗する。どの出力ファイルも処理されない。

```console
ffmpeg -i A.avi -i B.mp4 -i C.mkv -filter_complex "[1:v]hue=s=0[outv];overlay;aresample" \
    -an        out1.mp4 \
               out2.mkv \
    -map 1:a:0 out3.mkv
```

上記のコマンドも失敗する。色相フィルター `hue` の出力は `[outv]` というラベルが
ありながら、どこにも map されていない。次が修正済みコマンドだ：

```console
ffmpeg -i A.avi -i B.mp4 -i C.mkv -filter_complex "[1:v]hue=s=0,split=2[outv1][outv2];overlay;aresample" \
    -map '[outv1]' -an        out1.mp4 \
                              out2.mkv \
    -map '[outv2]' -map 1:a:0 out3.mkv
```

`[1:v]` 指定により、`B.mp4` の映像ストリームは `hue` フィルターに送られ、その
出力は `split` フィルターでいったん複製され、双方の出力にラベルが付けられる。そ
して、複製のそれぞれが出力ファイル `out1.mp4`, `out3.mkv` それぞれに map される。

フィルター `overlay` は、映像入力を二つ必要とし、最初の未使用の映像ストリーム二
つを使用する。ここでは `A.avi` と `C.mkv` のストリームだ。`overlay` 出力はラベル
が付いていないので、オプション `-map` の有無にかかわらず、最初の出力ファイル
`out1.mp4` に送信される。

フィルター `aresample` は、最初の未使用の音声ストリーム `A.avi` を送信する。この
フィルター出力もラベルが付いていないため、最初の出力ファイルに map される。オプ
ション `-an` は音声ストリームの自動的または手動的なストリーム選択を無効にするだ
けで、filtergraph から送信される出力は抑制しない。マップされたストリームはどち
らも `out1.mp4` の map されたストリームの前に並べられる。

Note: 上の記述の最後がわからない。

`out2.mkv` に map される映像、音声、字幕ストリームは（出力オプションが何もないの
で）すべて自動選択によって決定する。

`out3.mkv` は `hue` フィルターから出力された複製映像 (`[outv2]`)と、
`B.mp4` の最初の音声ストリーム (`-map 1:a:0`) から構成されている。
