---
title: Animation
---

## Bezier curve

<https://javascript.info/bezier-curve> ノート。

Bezier 曲線はコンピューターグラフィックスで図形を描いたり、CSS アニメーションに
使ったり、いろいろな用途がある。 Bezier 曲線はひじょうに単純なもので、一度学習し
ておけば、ベクターグラフィックスや高度なアニメーションの世界でも違和感なく使える
ようになる。

### Control points

Bezier 曲線は制御点によって定義される。
2点、3点、4点、またはそれ以上の場合がある。

ノート：本書ではここに 2, 3, 4 点それぞれの場合の曲線の例が図示されている。

これらの曲線をよく見てみると、すぐに気づくことがある。

1. 制御点は常に曲線上にあるわけではない。
2. 曲線の次数は制御点から 1 を引いた数に等しい。
   二点の場合は直線、三点の場合は放物線、四点の場合は三次曲線となる。
3. 曲線は常に制御点の凸包の中にある。

最後の convex hull property を利用して、コンピュータグラフィックスでは、交点検定
を最適化することが可能だ。凸包が交差しないのであれば、曲線も交差しない。したがっ
て、最初に凸包の交差をチェックすれば、高速に「交差なし」という結果を得られる。凸
包は長方形や三角形など（上の図参照）、曲線よりもずっと単純な図形なので、凸包の交
差をチェックするのはずっと簡単だ。

ノート：曲線が平面上にあることを仮定しているが、それは問題にしなくていい。

Bezier 曲線の描画における主な価値とは、制御点を移動することによって、曲線が直感的に明らかな方法で変化することにある。
本書の例を使って、マウスを使って制御点を対話的に動かせるので試す。

見ての通り、曲線は接線 12 と接戦 34 に沿って伸びている。
練習を重ねると、必要な曲線を得るために、どのように点を配置すればよいかが分かってくる。
また、いくつかの曲線をつなげば、ほとんどどんなものでも得ることができる。

ノート：本書で言う接続とは、単に端点を共有する程度に留まる。

### De Casteljau's algorithm

ノート：このデモは De Casteljau の計算手順を視覚的に示すものだ。
制御点が三つの（すなわち放物線を形成する）例を試す。
制御点はマウスで動かすことができ、再生ボタンをクリックすると、
曲線パラメーター `t` に対する点を 0 から 1 まで評価する。

De Casteljau の三点 Bezier 曲線構築の計算手順：

1. 制御点を描く。当デモでは 1, 2, 3 とラベルを付けてある。
2. 制御点 1, 2, 3 の間の線分を作図する（茶色の線）。
3. パラメータ `t` を 0 から 1 へと変化させる。この例では 0.05 刻みにしてある。

   これらの `t` の値のそれぞれについて。

   * 茶色の線分それぞれにおいて、その始点から `t` に比例した距離にある点を取る。
     線分が二つあるので、点も二つある。

     例えば、`t=0` の場合、点は線分の始点、`t=0.25` の場合、始点から線分の長さの 25% にあり、
     `t=0.5` の場合、中間にあり、`t=1` の場合、線分の終点だ。

   * 今得られた二点を結ぶ（青い線分）。
4. つまり、`t=0.25` の場合は、線分の左 1/4 の端に点があり、`t=0.5` の場合は、線
   分の中央に点があることになる（赤い点）。
5. `t` は 0 から 1 まであり、`t` の値ごとに曲線に一点ずつ追加される。
   そのような点の集合が Bezier 曲線を形成する（赤い放物線）。

以上の手順は三制御点に対するものだが、四点以上の場合も本質的には同じだ。
この計算手順は再帰的であり、任意の数の制御点に対して一般化できる。

N 個の制御点が与えられたとする。

1. それらを結んで N - 1 個の線分を最初は得る。
2. 次に、0 から 1 までの各 `t` について、`t` に比例した距離の各線分上の点を取り、それらを端点とする線分を作図する。
   すると N - 2 個の線分が得られる。
3. 点が一つだけになるまで 2. を繰り返す。

これらの点が曲線を作る。

上記の説明で不明な点があれば、本書のライブサンプルを触って、どのように曲線が構築されるかを確認する。
アルゴリズムは再帰的なので、任意の次数の Bezier 曲線を構築することができる。
しかし、実際には多くの点はほとんど役に立たない。
通常、2, 3 個の制御点を取り、複雑な線はそのような小次数の曲線を端点で接続して表現する。その方が簡単だからだ。

ノート：次数の大きい Bezier 曲線は計算量が明らかに多い。

----

Bezier 曲線を指定するには制御点を用いる。それらは最初と最後の点を除いて曲線上にない。

また、いくつかの点を通る曲線を描き、すべての点が一本の滑らかな曲線になるようにするという問題もある。
この作業は補間と呼ばれるが、ここでは扱わない。

このような曲線には、Lagrange 多項式などの数学的な公式がある。コンピュータグラ
フィックスでは、多くの点を結ぶ滑らかな曲線を作るために、スプライン補間がよく使われる。

### Maths

制御点 $P_i$ が座標の組で与えられると、最初の制御点の座標は
${P_1 = (x_1, y_1)}$, 二番目は ${P_2 = (x_2, y_2)}$, というように、曲線の座標は
線分 ${[0,1]}$ からパラメータ $t$ に依存する方程式で記述される。

二点の公式：

$$
P = (1-t)P_1 + tP_2
$$

三点の公式：

$$
P = (1−t)^2P_1 + 2(1−t)tP_2 + t^2P_3
$$

四点の公式：

$$
P = (1−t)^3P_1 + 3(1−t)^2tP_2 +3(1−t)t^2P_3 + t^3P_4
$$

パラメーター $t$ が 0 から 1 まで動くと、各 $t$ の値 ${(x, y)}$ の集合がそのような制御点の曲線を形成する。

## CSS-animations

<https://javascript.info/css-animations> ノート。

CSS では、JavaScript を全く使わずに簡単なアニメーションを行える。
さらに、JavaScript を使って CSS アニメーションを制御することで、少ないコードでより良いアニメーションを作れる。

### CSS transitions

CSS 遷移の考え方は単純だ。あるプロパティーを記述し、その変化をどのようにアニメーションさせるかを記述する。
プロパティーが変化すると、ブラウザーがそのアニメーションを描画する。
つまり、プロパティーを変更するだけで、ブラウザーが流動的な遷移を行うのだ。
例えば、次の CSS は `background-color` の変化を 3 秒間アニメーションさせる。
これで、要素に `.animated` クラスがあれば 3 秒間の背景色の変化がアニメーションで表示される：

```css
.animated {
    transition-property: background-color;
    transition-duration: 3s;
}
```

ノート：値が CSS のプロパティー名となるプロパティーは初めて見ると思う。
本書のデモでは、ボタンをクリックすると背景がアニメーションで赤へと変化していく。
ボタンの `onclick` で `this.style.backgroundColor = 'red';` としている。これが最終状態だ。

CSS 遷移を記述するプロパティーは四つある：

* `transition-property`
* `transition-duration`
* `transition-timing-function`
* `transition-delay`

差し当たり、共通 `transition` プロパティーによって、property duration
timing-function delay の順番でまとめて宣言できることと、複数のプロパティーを一度に
アニメーションさせることができることを押さえておく。

```html
<style>
#growing {
    transition: font-size 3s, color 2s;
}
</style>

<script>
growing.onclick = function() {
    this.style.fontSize = '36px';
    this.style.color = 'red';
};
</script>
```

ノート：組 (property duration timing-function delay) をカンマ区切りで列挙できるのだろう。

### transition-property

プロパティー `transition-property` には、アニメートさせたいプロパティーのリストを記述する。
また、`all` と書くと、すべてのプロパティーをアニメートすることになる。
一般的に使われているプロパティーのほとんどはアニメート可能だが、できないプロパティーもある。

### transition-duration

プロパティー `transition-duration` でアニメーション時間を指定できる。
CSS 時間書式で指定する。秒なら `s`, ミリ秒なら `ms` だ。

### transition-delay

プロパティー `transition-delay` には、アニメーションを開始するまでの遅延時間を指定できる。
例えば、`transition-delay: 1s` で `transition-duration: 2s` の場合、
アニメーションは当該プロパティーの変化から 1 秒後に始まり、全体の継続時間は 2 秒となる。

負の値も許される。その場合、アニメーションはすぐに表示されるが、アニメーション
の開始点は与えられた値（時間）後になる。例えば、`transition-delay: -1s` で
`transition-duration: 2s` の場合、アニメーションは中間点から始まり、全体の継続時間は 1 秒となる。

コメント：デモのスクリプトに注意。`onclick` で CSS クラスを与える方法を採っている。

また、`transition-delay` を負の値にすることで、遷移の途中、例えば現在の秒に相当
する正確な数字から開始させることも可能だ。

### transition-timing-function

プロパティー `transition-timing-function` には、アニメーションの進行を時間軸に沿ってどのように配分するかを記述する。
このプロパティーは Bezier 曲線と階段関数の二種類の値を取ることができる。

#### Bezier curve

タイミング関数、次の条件を満たす四制御点からなる Bezier 曲線として設定できる：

1. 最初の制御点は (0, 0)
2. 最後の制御点は (1, 1)
3. 中間点では x の値は区間 (0, 1) 内でなければならず、y は何でもよい。

CSS での Bezier 曲線の構文はこうなる：

```text
cubic-bezier(x2, y2, x3, y3)
```

最初と最後の制御点は固定されているので、間の二点だけを指定する。

タイミング関数はアニメーション処理の速さを記述する：

1. x 成分は時刻を指定する: 0: 開始、1: 終了。
2. y 成分は処理の完了を指定する。0: 開始値、1: 最終値。

最も単純な変種は、アニメーションが等速で進む場合だ。これは曲線 `cubic-bezier(0, 0, 1, 1)` で指定することができる。

列車のデモは解説がほとんど要らない。要素の位置を指定するのに `left` を援用するくらいか。

次の曲線は初速がえらいことになっている。

組み込み曲線がいくつか用意されている。

* `linear`: `cubic-bezier(0, 0, 1, 1)` と形は同じ曲線。すなわち直線。
* `ease`: `cubic-bezier(0.25, 0.1, 0.25, 1.0)`
* `ease-in`: `cubic-bezier(0.42, 0, 1.0, 1.0)`
* `ease-out`: `cubic-bezier(0, 0, 0.58, 1.0)`
* `ease-in-out`: `cubic-bezier(0.42, 0, 0.58, 1.0)|`

`transition-timing-function` の既定値は `ease` だ。

TODO

#### Steps

### Event: "transitionend"

### Keyframes

### Performance

### Summary

### Tasks

#### Animate a plane (CSS)

#### Animate the flying plane (CSS)

#### Animated circle

#### Animated circle with callback

### Comments

## JavaScript animations

<https://javascript.info/js-animation> ノート。

### CSS transitions

### transition-property

### transition-duration

### transition-delay

### transition-timing-function

#### Bezier curve

#### Steps

### Event: "transitionend"

### Keyframes

### Performance

### Summary

### Tasks

#### Animate a plane (CSS)

#### Animate the flying plane (CSS)

#### Animated circle

#### Animated circle with callback

### Comments
